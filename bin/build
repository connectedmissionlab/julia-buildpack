#!/usr/bin/env bash

set -euo pipefail

layer=$CNB_LAYERS_DIR
julia_layer=$layer/julia
julia_launch=$layer/launchjulia
mkdir -p $julia_layer $julia_launch

curl -fsSL https://install.julialang.org | sh -s -- --add-to-path=0 --yes --path $julia_layer

echo "instantiating ..."
bash -c "${julia_layer}/bin/julia -e 'using Pkg; Pkg.instantiate(); Pkg.precompile();'";
echo "done"

# save the julia home directory
echo "generating launch script ..."
cp -r $HOME/.julia $layer/dotjulia
cat > $julia_launch/julia.sh << EOL
#!/bin/bash
mv $layer/dotjulia $HOME/.julia
$layer/julia/bin/./julia
EOL
chmod +x $julia_launch/julia.sh
echo "done"

# make julia available during launch
echo -e '[types]\nlaunch = true' > $layer/julia.toml
echo -e '[types]\nlaunch = true' > $layer/dotjulia.toml
echo -e '[types]\nlaunch = true' > $layer/launchjulia.toml

# default launch process
cat > $layer/launch.toml << EOL
[[processes]]
type = "shell"
command = ["${layer}/launchjulia/./julia.sh"]
default = true
EOL

exit 0
